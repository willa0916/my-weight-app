<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é«”æ…‹è¿½è¹¤ v2.2 (ä¿®æ­£ç‰ˆ)</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { background-color: #f8f9fa; font-family: "Microsoft JhengHei", sans-serif; }
        .card { border: none; box-shadow: 0 4px 15px rgba(0,0,0,0.05); margin-bottom: 25px; border-radius: 12px; }
        .card-header { background-color: #fff; border-bottom: 1px solid #eee; font-weight: bold; font-size: 1.1rem; padding: 15px 20px; }
        .badge-bmi-ok { background-color: #198754; } 
        .badge-bmi-warn { background-color: #ffc107; color: #000; }
        .badge-bmi-danger { background-color: #dc3545; }
        .delete-btn { color: #dc3545; cursor: pointer; margin-left: 10px; }
        .optional-label { font-size: 0.85em; color: #6c757d; font-weight: normal; }
    </style>
</head>
<body>

<div class="container py-4">
    <h2 class="text-center mb-4 fw-bold text-primary">ğŸ“Š é«”æ…‹åˆ†æå„€ v2.2 (ä¿®æ­£ç‰ˆ)</h2>

    <div class="card">
        <div class="card-header">âš™ï¸ åŸºæœ¬è¨­å®š (å„²å­˜ç´€éŒ„æ™‚æœƒè‡ªå‹•æ›´æ–°é€™è£¡)</div>
        <div class="card-body">
            <div class="row g-3">
                <div class="col-md-4">
                    <label class="form-label">èº«é«˜ (cm)</label>
                    <input type="number" id="settingHeight" class="form-control" value="160">
                </div>
                <div class="col-md-4">
                    <label class="form-label">ç›®æ¨™é«”é‡ (kg)</label>
                    <input type="number" id="targetWeight" class="form-control" placeholder="é¸å¡«">
                </div>
                <div class="col-md-4">
                    <label class="form-label">ç›®æ¨™é«”è„‚ç‡ (%)</label>
                    <input type="number" id="targetFat" class="form-control" placeholder="é¸å¡«">
                </div>
            </div>
        </div>
    </div>

    <div class="card">
        <div class="card-header">â• æ–°å¢ç´€éŒ„</div>
        <div class="card-body">
            <div class="row g-3">
                <div class="col-md-3">
                    <label class="form-label text-danger fw-bold">æ—¥æœŸ *</label>
                    <input type="date" id="inputDate" class="form-control">
                </div>
                <div class="col-md-3">
                    <label class="form-label text-danger fw-bold">é«”é‡ (kg) *</label>
                    <input type="number" id="inputWeight" class="form-control" step="0.1" placeholder="å¿…å¡«">
                </div>
                <div class="col-md-3">
                    <label class="form-label">æ€§åˆ¥</label>
                    <select id="inputGender" class="form-select" onchange="toggleHipInput()">
                        <option value="female">å¥³æ€§</option>
                        <option value="male">ç”·æ€§</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <label class="form-label">æ´»å‹•é‡</label>
                    <select id="inputActivity" class="form-select">
                        <option value="1.2">ä¹…å (è¾¦å…¬å®¤)</option>
                        <option value="1.375">è¼•åº¦é‹å‹•</option>
                        <option value="1.55">ä¸­åº¦é‹å‹•</option>
                        <option value="1.725">é«˜åº¦é‹å‹•</option>
                    </select>
                </div>

                <div class="col-12"><hr class="my-2 text-muted"></div>
                <div class="col-12">
                    <small class="text-secondary">ğŸ“ é«”è„‚æ¸¬é‡ (é¸å¡«ï¼Œä¸å¡«å‰‡åªè¨˜éŒ„é«”é‡)</small>
                </div>

                <div class="col-md-4">
                    <label class="form-label">é ¸åœ (cm)</label>
                    <input type="number" id="inputNeck" class="form-control" placeholder="é¸å¡«">
                </div>
                <div class="col-md-4">
                    <label class="form-label">è…°åœ (cm)</label>
                    <input type="number" id="inputWaist" class="form-control" placeholder="é¸å¡«">
                </div>
                <div class="col-md-4" id="hipInputGroup">
                    <label class="form-label">è‡€åœ (cm)</label>
                    <input type="number" id="inputHip" class="form-control" placeholder="é¸å¡«">
                </div>

                <div class="col-12 text-end mt-4">
                    <button onclick="addRecord()" class="btn btn-primary px-5 fw-bold">å„²å­˜ç´€éŒ„</button>
                </div>
            </div>
        </div>
    </div>

    <div class="card">
        <div class="card-header">ğŸ“ˆ è¶¨å‹¢åˆ†æ</div>
        <div class="card-body">
            <canvas id="trendChart" height="100"></canvas>
        </div>
    </div>

    <div class="card">
        <div class="card-header d-flex justify-content-between align-items-center">
            <span>ğŸ“‹ æ•¸æ“šåˆ—è¡¨</span>
            <button onclick="exportCSV()" class="btn btn-sm btn-success">ğŸ“¥ åŒ¯å‡º Excel</button>
        </div>
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-hover align-middle text-center" style="font-size: 0.9rem;">
                    <thead class="table-light">
                        <tr>
                            <th>æ—¥æœŸ</th>
                            <th>é«”é‡/é«”è„‚</th>
                            <th>BMI/FFMI</th>
                            <th>ä»£è¬ (BMR/TDEE)</th>
                            <th>åˆªé™¤</th>
                        </tr>
                    </thead>
                    <tbody id="recordList"></tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<script>
    // --- åˆå§‹åŒ–å€å¡Š ---
    try {
        // è¨­å®šä»Šå¤©çš„æ—¥æœŸ
        document.getElementById('inputDate').valueAsDate = new Date();
        
        // è®€å–è³‡æ–™ï¼Œå¦‚æœæ²’æœ‰å‰‡å»ºç«‹ç©ºé™£åˆ—
        var records = JSON.parse(localStorage.getItem('bodyTrackerData_v2')) || [];
        var settings = JSON.parse(localStorage.getItem('bodyTrackerSettings')) || { height: 160, targetW: '', targetF: '' };
        var myChart = null;

        // å°‡å„²å­˜çš„è¨­å®šå¡«å…¥æ¬„ä½
        if(document.getElementById('settingHeight')) document.getElementById('settingHeight').value = settings.height || 160;
        if(document.getElementById('targetWeight')) document.getElementById('targetWeight').value = settings.targetW || '';
        if(document.getElementById('targetFat')) document.getElementById('targetFat').value = settings.targetF || '';

        // å•Ÿå‹•æ¸²æŸ“
        renderAll();
    } catch (e) {
        alert("åˆå§‹åŒ–ç™¼ç”ŸéŒ¯èª¤ï¼Œè«‹é‡æ–°æ•´ç†ç¶²é ï¼š" + e.message);
    }

    // --- åŠŸèƒ½å€å¡Š ---

    function toggleHipInput() {
        const gender = document.getElementById('inputGender').value;
        const hipGroup = document.getElementById('hipInputGroup');
        if (hipGroup) {
            hipGroup.style.display = (gender === 'male') ? 'none' : 'block';
        }
    }

    // æ ¸å¿ƒåŠŸèƒ½ï¼šæ–°å¢ç´€éŒ„
    function addRecord() {
        try {
            // 1. å–å¾—æ¬„ä½å…ƒä»¶ (å¦‚æœæ‰¾ä¸åˆ°æœƒå ±éŒ¯)
            const dateEl = document.getElementById('inputDate');
            const weightEl = document.getElementById('inputWeight');
            const heightEl = document.getElementById('settingHeight');
            
            if (!dateEl || !weightEl || !heightEl) {
                throw new Error("æ‰¾ä¸åˆ°å¿…è¦çš„è¼¸å…¥æ¬„ä½ (ID Error)");
            }

            // 2. å–å¾—æ•¸å€¼
            const date = dateEl.value;
            const weight = parseFloat(weightEl.value);
            const height = parseFloat(heightEl.value);

            // 3. é©—è­‰å¿…å¡«é …ç›®
            if (!date) { alert("è«‹é¸æ“‡æ—¥æœŸï¼"); return; }
            if (isNaN(weight) || weight <= 0) { alert("è«‹è¼¸å…¥æœ‰æ•ˆçš„é«”é‡ï¼"); return; }
            if (isNaN(height) || height <= 0) { alert("è«‹è¼¸å…¥æœ‰æ•ˆçš„èº«é«˜ï¼"); return; }

            // è‡ªå‹•æ›´æ–°è¨­å®š (å°‡ç›®å‰çš„èº«é«˜èˆ‡ç›®æ¨™å­˜èµ·ä¾†)
            settings.height = height;
            settings.targetW = document.getElementById('targetWeight').value;
            settings.targetF = document.getElementById('targetFat').value;
            localStorage.setItem('bodyTrackerSettings', JSON.stringify(settings));

            // å–å¾—å…¶ä»–é¸å¡«æ•¸å€¼
            const gender = document.getElementById('inputGender').value;
            const activity = parseFloat(document.getElementById('inputActivity').value) || 1.2;
            const neck = parseFloat(document.getElementById('inputNeck').value);
            const waist = parseFloat(document.getElementById('inputWaist').value);
            const hip = parseFloat(document.getElementById('inputHip').value);

            // è¨ˆç®— BMI
            const heightM = height / 100;
            const bmi = (weight / (heightM ** 2)).toFixed(1);

            // åˆ¤æ–·æ˜¯å¦è¨ˆç®—é«”è„‚
            let bodyFat = null;
            let bmr = null;
            let tdee = null;
            let ffmi = null;

            // åªæœ‰ç•¶åœåº¦æœ‰æ•¸å€¼æ™‚æ‰è¨ˆç®—
            let hasData = false;
            if (gender === 'male' && !isNaN(neck) && !isNaN(waist)) hasData = true;
            if (gender === 'female' && !isNaN(neck) && !isNaN(waist) && !isNaN(hip)) hasData = true;

            if (hasData) {
                // ç¾åœ‹æµ·è»å…¬å¼
                if (gender === 'male') {
                    bodyFat = 495 / (1.0324 - 0.19077 * Math.log10(waist - neck) + 0.1554 * Math.log10(height)) - 450;
                } else {
                    bodyFat = 495 / (1.29579 - 0.35004 * Math.log10(waist + hip - neck) + 0.22100 * Math.log10(height)) - 450;
                }

                // é¿å…è¼¸å…¥ä¸åˆç†å°è‡´è¨ˆç®—å‡ºç„¡é™å¤§æˆ– NaN
                if (!isFinite(bodyFat) || isNaN(bodyFat)) {
                    bodyFat = null; // æ•¸æ“šä¸åˆç†ï¼Œè¦–ç‚ºæœªå¡«
                } else {
                    bodyFat = bodyFat.toFixed(1);
                    // é€²éšè¨ˆç®—
                    const lbm = weight * (1 - (bodyFat / 100));
                    bmr = Math.round(370 + (21.6 * lbm));
                    tdee = Math.round(bmr * activity);
                    ffmi = (lbm / (heightM ** 2)).toFixed(1);
                }
            }

            // å»ºç«‹è³‡æ–™ç‰©ä»¶
            const newRecord = {
                id: Date.now(),
                date,
                weight,
                bmi,
                bodyFat,
                bmr,
                tdee,
                ffmi
            };

            // å­˜æª”
            records.push(newRecord);
            records.sort((a, b) => new Date(a.date) - new Date(b.date));
            localStorage.setItem('bodyTrackerData_v2', JSON.stringify(records));
            
            // æ›´æ–°ç•«é¢
            renderAll();
            
            // æ¸…ç©ºè¼¸å…¥æ¡†
            weightEl.value = '';
            document.getElementById('inputNeck').value = '';
            document.getElementById('inputWaist').value = '';
            document.getElementById('inputHip').value = '';
            
            // æˆåŠŸæç¤º (å¯é¸ï¼Œè¦ºå¾—åµå¯ä»¥è¨»è§£æ‰)
            // alert("ç´€éŒ„å·²å„²å­˜ï¼"); 

        } catch (error) {
            alert("ç™¼ç”ŸéŒ¯èª¤ï¼Œç„¡æ³•å„²å­˜ï¼š" + error.message);
            console.error(error);
        }
    }

    function deleteRecord(id) {
        if(confirm("ç¢ºå®šåˆªé™¤æ­¤ç­†è³‡æ–™ï¼Ÿ")) {
            records = records.filter(r => r.id !== id);
            localStorage.setItem('bodyTrackerData_v2', JSON.stringify(records));
            renderAll();
        }
    }

    function exportCSV() {
        if(records.length === 0) { alert('æ²’æœ‰è³‡æ–™å¯ä»¥åŒ¯å‡º'); return; }
        let csvContent = "\uFEFFæ—¥æœŸ,é«”é‡(kg),é«”è„‚ç‡(%),BMI,FFMI,BMR,TDEE\n";
        records.forEach(r => {
            csvContent += `${r.date},${r.weight},${r.bodyFat||''},${r.bmi},${r.ffmi||''},${r.bmr||''},${r.tdee||''}\n`;
        });
        const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement("a");
        link.href = URL.createObjectURL(blob);
        link.download = `é«”æ…‹ç´€éŒ„_${new Date().toISOString().slice(0,10)}.csv`;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    }

    // æ¸²æŸ“åœ–è¡¨èˆ‡åˆ—è¡¨
    function renderAll() {
        const tbody = document.getElementById('recordList');
        if(!tbody) return;
        tbody.innerHTML = '';

        const labels = [];
        const weightData = [];
        const fatData = [];

        records.forEach(r => {
            // ç”Ÿæˆ HTML
            let fatHtml = r.bodyFat ? `<span class="${r.bodyFat > 30 ? 'text-danger':'text-success'}">${r.bodyFat}%</span>` : '<span class="text-muted">-</span>';
            let tdeeHtml = r.tdee ? `<div class="fw-bold text-primary">${r.tdee}</div>` : '<span class="text-muted">-</span>';

            const row = `<tr>
                <td>${r.date}</td>
                <td><div class="fw-bold">${r.weight}</div>${fatHtml}</td>
                <td><div>BMI: ${r.bmi}</div><small class="text-muted">${r.ffmi ? 'FFMI:'+r.ffmi : ''}</small></td>
                <td>${tdeeHtml}<small class="text-muted">${r.bmr ? 'BMR:'+r.bmr : ''}</small></td>
                <td><span class="delete-btn" onclick="deleteRecord(${r.id})">âŒ</span></td>
            </tr>`;
            tbody.innerHTML = row + tbody.innerHTML;

            labels.push(r.date);
            weightData.push(r.weight);
            fatData.push(r.bodyFat);
        });

        // ç¹ªåœ–
        const ctx = document.getElementById('trendChart');
        if (ctx) {
            const targetW = settings.targetW ? Array(labels.length).fill(settings.targetW) : [];
            const targetF = settings.targetF ? Array(labels.length).fill(settings.targetF) : [];
            
            if (myChart) myChart.destroy();
            
            myChart = new Chart(ctx.getContext('2d'), {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [
                        { label: 'é«”é‡', data: weightData, borderColor: '#0d6efd', backgroundColor: '#0d6efd', yAxisID: 'y', tension: 0.3, spanGaps: true },
                        { label: 'é«”è„‚', data: fatData, borderColor: '#198754', backgroundColor: '#198754', yAxisID: 'y1', tension: 0.3, spanGaps: false },
                        { label: 'ç›®æ¨™é«”é‡', data: targetW, borderColor: '#0d6efd', borderDash: [5, 5], pointRadius: 0, borderWidth: 1, yAxisID: 'y' },
                        { label: 'ç›®æ¨™é«”è„‚', data: targetF, borderColor: '#198754', borderDash: [5, 5], pointRadius: 0, borderWidth: 1, yAxisID: 'y1' }
                    ]
                },
                options: {
                    responsive: true,
                    interaction: { mode: 'index', intersect: false },
                    scales: {
                        y: { type: 'linear', display: true, position: 'left' },
                        y1: { type: 'linear', display: true, position: 'right', grid: {drawOnChartArea: false} }
                    }
                }
            });
        }
    }
</script>

</body>
</html>