<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é›²ç«¯é«”æ…‹è¿½è¹¤</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { background-color: #f8f9fa; font-family: "Microsoft JhengHei", sans-serif; }
        .card { border: none; box-shadow: 0 4px 15px rgba(0,0,0,0.05); margin-bottom: 25px; border-radius: 12px; }
        .card-header { background-color: #fff; border-bottom: 1px solid #eee; font-weight: bold; font-size: 1.1rem; padding: 15px 20px; }
        .loading-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.85); z-index: 9999; display: flex; justify-content: center; align-items: center; flex-direction: column; visibility: hidden; backdrop-filter: blur(3px); }
        .spinner-border { width: 3rem; height: 3rem; }
        .optional-section { display: none; background-color: #f8f9fa; padding: 15px; border-radius: 8px; margin-top: 10px; }
        .btn-toggle-opt { font-size: 0.9rem; color: #6c757d; text-decoration: none; cursor: pointer; }
        .btn-toggle-opt:hover { color: #0d6efd; }
    </style>
</head>
<body>

<div id="loading" class="loading-overlay">
    <div class="spinner-border text-primary" role="status"></div>
    <h4 class="mt-3 text-primary fw-bold">é›²ç«¯åŒæ­¥ä¸­...</h4>
    <p class="text-muted">æ­£åœ¨èˆ‡ Google è³‡æ–™åº«é€£ç·š</p>
</div>

<div class="container py-4">
    <h2 class="text-center mb-4 fw-bold text-primary">â˜ï¸ é›²ç«¯é«”é‡è¨ˆéŒ„å™¨</h2>

    <div class="card">
        <div class="card-header d-flex justify-content-between align-items-center">
            <span>âš™ï¸ å€‹äººè¨­å®š</span>
            <button onclick="saveSettings()" class="btn btn-sm btn-outline-primary">å„²å­˜è¨­å®š</button>
        </div>
        <div class="card-body">
            <div class="row g-2">
                <div class="col-4">
                    <label class="small text-muted">èº«é«˜(cm)</label>
                    <input type="number" id="setHeight" class="form-control" value="160">
                </div>
                <div class="col-4">
                    <label class="small text-muted">ç›®æ¨™é«”é‡</label>
                    <input type="number" id="setTargetW" class="form-control" placeholder="kg">
                </div>
                <div class="col-4">
                    <label class="small text-muted">ç›®æ¨™é«”è„‚</label>
                    <input type="number" id="setTargetF" class="form-control" placeholder="%">
                </div>
            </div>
        </div>
    </div>

    <div class="card">
        <div class="card-header">â• æ–°å¢ä»Šæ—¥ç´€éŒ„</div>
        <div class="card-body">
            <div class="row g-3">
                <div class="col-6">
                    <label class="form-label text-danger fw-bold">æ—¥æœŸ</label>
                    <input type="date" id="inputDate" class="form-control">
                </div>
                <div class="col-6">
                    <label class="form-label text-danger fw-bold">é«”é‡ (kg)</label>
                    <input type="number" id="inputWeight" class="form-control" step="0.1" placeholder="è¼¸å…¥é«”é‡">
                </div>
                
                <div class="col-6">
                    <label class="form-label">æ´»å‹•é‡ <small>(å½±éŸ¿TDEE)</small></label>
                    <select id="inputActivity" class="form-select">
                        <option value="1.2">ä¹…å (è¾¦å…¬å®¤/æ²’é‹å‹•)</option>
                        <option value="1.375">è¼•åº¦ (æ¯é€±1-3å¤©)</option>
                        <option value="1.55">ä¸­åº¦ (æ¯é€±3-5å¤©)</option>
                        <option value="1.725">é«˜åº¦ (æ¯é€±6-7å¤©)</option>
                    </select>
                </div>
                <div class="col-6">
                    <label class="form-label">æ€§åˆ¥</label>
                    <select id="inputGender" class="form-select" onchange="toggleHip()">
                        <option value="female">å¥³æ€§</option>
                        <option value="male">ç”·æ€§</option>
                    </select>
                </div>

                <div class="col-12 text-center">
                    <a class="btn-toggle-opt" onclick="toggleOptional()">â–¼ é»æ­¤å¡«å¯«åœåº¦ (è¨ˆç®—é«”è„‚ç‡/BMR/TDEE)</a>
                </div>
                
                <div id="optionalSection" class="optional-section">
                    <div class="row g-2">
                        <div class="col-12"><small class="text-primary">å¡«å¯«ä¸‹æ–¹æ•¸æ“šï¼Œç³»çµ±å°‡è‡ªå‹•è¨ˆç®—æ‚¨çš„é«”è„‚ç‡èˆ‡ä»£è¬ç‡</small></div>
                        <div class="col-4">
                            <label class="small">é ¸åœ(cm)</label>
                            <input type="number" id="inputNeck" class="form-control">
                        </div>
                        <div class="col-4">
                            <label class="small">è…°åœ(cm)</label>
                            <input type="number" id="inputWaist" class="form-control">
                        </div>
                        <div class="col-4" id="divHip">
                            <label class="small">è‡€åœ(cm)</label>
                            <input type="number" id="inputHip" class="form-control">
                        </div>
                    </div>
                </div>

                <div class="col-12 text-end mt-3">
                    <button onclick="uploadRecord()" class="btn btn-primary px-5 fw-bold w-100">ä¸Šå‚³ç´€éŒ„</button>
                </div>
            </div>
        </div>
    </div>

    <div class="card">
        <div class="card-header d-flex justify-content-between">
            <span>ğŸ“ˆ è¶¨å‹¢åœ– (è™›ç·šç‚ºç›®æ¨™)</span>
            <button onclick="fetchData()" class="btn btn-sm btn-outline-secondary">ğŸ”„ åˆ·æ–°</button>
        </div>
        <div class="card-body">
            <canvas id="trendChart" height="200"></canvas>
        </div>
    </div>

    <div class="card">
        <div class="card-header">ğŸ“‹ è©³ç´°æ•¸æ“š</div>
        <div class="card-body p-0">
            <div class="table-responsive">
                <table class="table table-striped text-center mb-0" style="font-size: 0.9rem;">
                    <thead class="table-dark"><tr><th>æ—¥æœŸ</th><th>é«”é‡/é«”è„‚</th><th>BMI</th><th>ä»£è¬(TDEE)</th></tr></thead>
                    <tbody id="recordList"></tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<script>
    // ==========================================
    // âš ï¸ è«‹åœ¨æ­¤è™•è²¼ä¸Šæ‚¨çš„ Google Apps Script ç¶²å€
    const GOOGLE_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbyJc6Com9wU5CtMvVAI57bFUBHs3o8etDRJCR7CzvYMLEQChvFoxGSjM8hCYGxI_gBKRA/exec"; 
    // ==========================================

    let records = [];
    let myChart = null;
    
    // åˆå§‹åŒ–
    window.onload = function() {
        document.getElementById('inputDate').valueAsDate = new Date();
        loadSettings();
        if(GOOGLE_SCRIPT_URL.includes("æ‚¨çš„ç¶²å€")) {
            alert("è«‹è¨˜å¾—ä¿®æ”¹ç¨‹å¼ç¢¼ä¸­çš„ Google ç¶²å€ï¼");
        } else {
            fetchData();
        }
    };

    // ä»‹é¢äº’å‹•åŠŸèƒ½
    function toggleOptional() {
        const sec = document.getElementById('optionalSection');
        sec.style.display = (sec.style.display === 'block') ? 'none' : 'block';
    }
    function toggleHip() {
        const isMale = document.getElementById('inputGender').value === 'male';
        document.getElementById('divHip').style.display = isMale ? 'none' : 'block';
    }
    function toggleLoading(show) {
        document.getElementById('loading').style.visibility = show ? 'visible' : 'hidden';
    }

    // æœ¬åœ°è¨­å®šå­˜å– (Local Storage)
    function saveSettings() {
        const s = {
            h: document.getElementById('setHeight').value,
            tw: document.getElementById('setTargetW').value,
            tf: document.getElementById('setTargetF').value
        };
        localStorage.setItem('myBodySettings', JSON.stringify(s));
        alert("è¨­å®šå·²å„²å­˜ (å°‡ç”¨æ–¼ä¸‹æ¬¡é–‹å•Ÿèˆ‡åœ–è¡¨)");
        renderAll(); // é‡ç¹ªåœ–è¡¨ä»¥æ›´æ–°ç›®æ¨™ç·š
    }
    function loadSettings() {
        const s = JSON.parse(localStorage.getItem('myBodySettings'));
        if(s) {
            if(s.h) document.getElementById('setHeight').value = s.h;
            if(s.tw) document.getElementById('setTargetW').value = s.tw;
            if(s.tf) document.getElementById('setTargetF').value = s.tf;
        }
    }

    // è³‡æ–™è™•ç†é‚è¼¯
    function fetchData() {
        toggleLoading(true);
        fetch(GOOGLE_SCRIPT_URL)
        .then(res => res.json())
        .then(data => {
            records = data; 
            records.sort((a, b) => new Date(a.date) - new Date(b.date)); // ç¢ºä¿æ—¥æœŸæ’åº
            renderAll();
            toggleLoading(false);
        })
        .catch(e => {
            console.error(e);
            toggleLoading(false);
        });
    }

    function uploadRecord() {
        const date = document.getElementById('inputDate').value;
        const weight = parseFloat(document.getElementById('inputWeight').value);
        const height = parseFloat(document.getElementById('setHeight').value); // è®€å–è¨­å®šå€çš„èº«é«˜
        const activity = parseFloat(document.getElementById('inputActivity').value);
        
        if (!date || !weight) { alert("æ—¥æœŸèˆ‡é«”é‡ç‚ºå¿…å¡«ï¼"); return; }
        if (!height) { alert("è«‹å…ˆåœ¨ä¸Šæ–¹è¨­å®šå€è¼¸å…¥èº«é«˜ï¼"); return; }

        // è¨ˆç®—é‚è¼¯
        const heightM = height / 100;
        const bmi = (weight / (heightM ** 2)).toFixed(1);
        
        // é«”è„‚èˆ‡ä»£è¬è¨ˆç®—
        const gender = document.getElementById('inputGender').value;
        const neck = parseFloat(document.getElementById('inputNeck').value);
        const waist = parseFloat(document.getElementById('inputWaist').value);
        const hip = parseFloat(document.getElementById('inputHip').value);
        
        let bodyFat = '', bmr = '', tdee = '', ffmi = '';
        
        // åˆ¤æ–·æ˜¯å¦è³‡æ–™å……è¶³
        let hasData = false;
        if (gender === 'male' && neck && waist) hasData = true;
        if (gender === 'female' && neck && waist && hip) hasData = true;

        if (hasData) {
            // 1. é«”è„‚ç‡ (æµ·è»å…¬å¼)
            if (gender === 'male') {
                bodyFat = 495 / (1.0324 - 0.19077 * Math.log10(waist - neck) + 0.1554 * Math.log10(height)) - 450;
            } else {
                bodyFat = 495 / (1.29579 - 0.35004 * Math.log10(waist + hip - neck) + 0.22100 * Math.log10(height)) - 450;
            }
            bodyFat = parseFloat(bodyFat.toFixed(1));

            // 2. ä»£è¬ç‡ (Katch-McArdle å…¬å¼ - è¼ƒæº–ç¢ºï¼Œå› åŸºæ–¼ç˜¦é«”é‡)
            const lbm = weight * (1 - (bodyFat / 100)); // ç˜¦é«”é‡
            bmr = Math.round(370 + (21.6 * lbm));
            tdee = Math.round(bmr * activity); // é€™è£¡åŠ å…¥äº†æ´»å‹•é‡ä¿‚æ•¸
            ffmi = (lbm / (heightM ** 2)).toFixed(1);
        }

        const payload = {
            date: date,
            weight: weight,
            bmi: bmi,
            bodyFat: bodyFat,
            ffmi: ffmi,
            bmr: bmr,
            tdee: tdee
        };

        toggleLoading(true);

        fetch(GOOGLE_SCRIPT_URL, {
            method: 'POST',
            mode: 'no-cors',
            headers: { 'Content-Type': 'text/plain' },
            body: JSON.stringify(payload)
        }).then(() => {
            setTimeout(() => {
                alert("ä¸Šå‚³æˆåŠŸï¼");
                fetchData();
                // æ¸…ç©ºè®Šå‹•æ¬„ä½
                document.getElementById('inputWeight').value = '';
            }, 1000); 
        }).catch(e => {
            alert("ä¸Šå‚³éŒ¯èª¤ï¼š" + e);
            toggleLoading(false);
        });
    }

    function renderAll() {
        const tbody = document.getElementById('recordList');
        tbody.innerHTML = '';
        
        const labels = [], wData = [], fData = [];
        
        // è®€å–ç›®æ¨™è¨­å®š
        const targetW = document.getElementById('setTargetW').value;
        const targetF = document.getElementById('setTargetF').value;
        const tWData = [], tFData = [];

        records.forEach(r => {
            // åˆ—è¡¨é¡¯ç¤º
            const d = r.date.substring(5, 10); // åªé¡¯ç¤º æœˆ-æ—¥
            const fatShow = r.bodyFat ? `<br><span class="small text-success">${r.bodyFat}%</span>` : '';
            const tdeeShow = r.tdee ? `<span class="fw-bold text-primary">${r.tdee}</span>` : '-';
            const bmrShow = r.bmr ? `<br><span class="small text-muted">BMR:${r.bmr}</span>` : '';

            const row = `<tr>
                <td>${d}</td>
                <td><b>${r.weight}</b>${fatShow}</td>
                <td>${r.bmi}</td>
                <td>${tdeeShow}${bmrShow}</td>
            </tr>`;
            tbody.innerHTML = row + tbody.innerHTML; // æ–°çš„åœ¨ä¸Šé¢

            // åœ–è¡¨æ•¸æ“š
            labels.push(d);
            wData.push(r.weight);
            fData.push(r.bodyFat || null);
            tWData.push(targetW || null);
            tFData.push(targetF || null);
        });

        drawChart(labels, wData, fData, tWData, tFData);
    }

    function drawChart(labels, wData, fData, tWData, tFData) {
        const ctx = document.getElementById('trendChart').getContext('2d');
        if (myChart) myChart.destroy();
        
        myChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: labels,
                datasets: [
                    { label: 'é«”é‡', data: wData, borderColor: '#0d6efd', yAxisID: 'y', tension: 0.3 },
                    { label: 'é«”è„‚', data: fData, borderColor: '#198754', yAxisID: 'y1', tension: 0.3, spanGaps: false },
                    // ç›®æ¨™ç·š
                    { label: 'ç›®æ¨™é«”é‡', data: tWData, borderColor: '#0d6efd', borderDash: [5,5], pointRadius: 0, borderWidth: 1, yAxisID: 'y', fill: false },
                    { label: 'ç›®æ¨™é«”è„‚', data: tFData, borderColor: '#198754', borderDash: [5,5], pointRadius: 0, borderWidth: 1, yAxisID: 'y1', fill: false }
                ]
            },
            options: {
                responsive: true,
                interaction: { mode: 'index', intersect: false },
                scales: {
                    y: { type: 'linear', display: true, position: 'left', title: {display:true, text:'é«”é‡'} },
                    y1: { type: 'linear', display: true, position: 'right', grid: {drawOnChartArea: false}, title: {display:true, text:'é«”è„‚%'} }
                }
            }
        });
    }
</script>

</body>
</html>
