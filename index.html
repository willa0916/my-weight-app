<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é›²ç«¯é«”æ…‹è¿½è¹¤</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { background-color: #f8f9fa; font-family: "Microsoft JhengHei", sans-serif; }
        .card { border: none; box-shadow: 0 4px 15px rgba(0,0,0,0.05); margin-bottom: 25px; border-radius: 12px; }
        .card-header { background-color: #fff; border-bottom: 1px solid #eee; font-weight: bold; font-size: 1.1rem; padding: 15px 20px; }
        .loading-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.85); z-index: 9999; display: flex; justify-content: center; align-items: center; flex-direction: column; visibility: hidden; backdrop-filter: blur(3px); }
        .spinner-border { width: 3rem; height: 3rem; }
        .optional-section { display: none; background-color: #f8f9fa; padding: 15px; border-radius: 8px; margin-top: 10px; }
        .btn-toggle-opt { font-size: 0.9rem; color: #6c757d; text-decoration: none; cursor: pointer; }
        .btn-del { border: 1px solid #dc3545; color: #dc3545; background: none; border-radius: 5px; padding: 2px 8px; font-size: 0.8rem; transition: 0.2s; }
        .btn-del:hover { background: #dc3545; color: white; }
    </style>
</head>
<body>

<div id="loading" class="loading-overlay">
    <div class="spinner-border text-primary" role="status"></div>
    <h4 class="mt-3 text-primary fw-bold">è™•ç†ä¸­...</h4>
    <p class="text-muted">æ­£åœ¨èˆ‡é›²ç«¯è³‡æ–™åº«åŒæ­¥</p>
</div>

<div class="container py-4">
    <h2 class="text-center mb-4 fw-bold text-primary">â˜ï¸é›²ç«¯é«”é‡è¨ˆéŒ„å™¨ v3.2</h2>

    <div class="card">
        <div class="card-header d-flex justify-content-between align-items-center">
            <span>âš™ï¸ è¨­å®š</span>
            <button onclick="saveSettings()" class="btn btn-sm btn-outline-primary">å„²å­˜</button>
        </div>
        <div class="card-body">
            <div class="row g-2">
                <div class="col-4"><label class="small text-muted">èº«é«˜(cm)</label><input type="number" id="setHeight" class="form-control" value="160"></div>
                <div class="col-4"><label class="small text-muted">ç›®æ¨™é«”é‡</label><input type="number" id="setTargetW" class="form-control"></div>
                <div class="col-4"><label class="small text-muted">ç›®æ¨™é«”è„‚</label><input type="number" id="setTargetF" class="form-control"></div>
            </div>
        </div>
    </div>

    <div class="card">
        <div class="card-header">â• æ–°å¢ç´€éŒ„</div>
        <div class="card-body">
            <div class="row g-3">
                <div class="col-6"><label class="form-label text-danger fw-bold">æ—¥æœŸ</label><input type="date" id="inputDate" class="form-control"></div>
                <div class="col-6"><label class="form-label text-danger fw-bold">é«”é‡</label><input type="number" id="inputWeight" class="form-control" step="0.1"></div>
                <div class="col-6"><label class="form-label">æ´»å‹•é‡</label><select id="inputActivity" class="form-select"><option value="1.2">ä¹…å</option><option value="1.375">è¼•åº¦</option><option value="1.55">ä¸­åº¦</option><option value="1.725">é«˜åº¦</option></select></div>
                <div class="col-6"><label class="form-label">æ€§åˆ¥</label><select id="inputGender" class="form-select" onchange="toggleHip()"><option value="female">å¥³æ€§</option><option value="male">ç”·æ€§</option></select></div>

                <div class="col-12 text-center"><a class="btn-toggle-opt" onclick="toggleOptional()">â–¼ å¡«å¯«åœåº¦ (é¸å¡«)</a></div>
                <div id="optionalSection" class="optional-section">
                    <div class="row g-2">
                        <div class="col-4"><label class="small">é ¸åœ</label><input type="number" id="inputNeck" class="form-control"></div>
                        <div class="col-4"><label class="small">è…°åœ</label><input type="number" id="inputWaist" class="form-control"></div>
                        <div class="col-4" id="divHip"><label class="small">è‡€åœ</label><input type="number" id="inputHip" class="form-control"></div>
                    </div>
                </div>

                <div class="col-12 text-end mt-3"><button onclick="uploadRecord()" class="btn btn-primary px-5 w-100 fw-bold">ä¸Šå‚³ç´€éŒ„</button></div>
            </div>
        </div>
    </div>

    <div class="card">
        <div class="card-header d-flex justify-content-between"><span>ğŸ“ˆ è¶¨å‹¢</span><button onclick="fetchData()" class="btn btn-sm btn-outline-secondary">ğŸ”„</button></div>
        <div class="card-body"><canvas id="trendChart" height="200"></canvas></div>
    </div>

    <div class="card">
        <div class="card-header">ğŸ“‹ æ•¸æ“šåˆ—è¡¨</div>
        <div class="card-body p-0">
            <div class="table-responsive">
                <table class="table table-striped text-center align-middle mb-0" style="font-size: 0.9rem;">
                    <thead class="table-dark"><tr><th>æ—¥æœŸ</th><th>é«”é‡/é«”è„‚</th><th>ä»£è¬/BMI</th><th>æ“ä½œ</th></tr></thead>
                    <tbody id="recordList"></tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<script>
    // ==========================================
    // âš ï¸ è«‹åœ¨æ­¤è™•è²¼ä¸Šæ‚¨çš„ Google Apps Script ç¶²å€
    const GOOGLE_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbyJc6Com9wU5CtMvVAI57bFUBHs3o8etDRJCR7CzvYMLEQChvFoxGSjM8hCYGxI_gBKRA/exec"; 
    // ==========================================

    let records = [];
    let myChart = null;
    
    window.onload = function() {
        document.getElementById('inputDate').valueAsDate = new Date();
        loadSettings();
        if(GOOGLE_SCRIPT_URL.includes("æ‚¨çš„ç¶²å€")) alert("è«‹ä¿®æ”¹ç¨‹å¼ç¢¼ä¸­çš„ Google ç¶²å€ï¼");
        else fetchData();
    };

    function toggleOptional() {
        const sec = document.getElementById('optionalSection');
        sec.style.display = (sec.style.display === 'block') ? 'none' : 'block';
    }
    function toggleHip() {
        const isMale = document.getElementById('inputGender').value === 'male';
        document.getElementById('divHip').style.display = isMale ? 'none' : 'block';
    }
    function toggleLoading(show) { document.getElementById('loading').style.visibility = show ? 'visible' : 'hidden'; }

    function saveSettings() {
        const s = { h: document.getElementById('setHeight').value, tw: document.getElementById('setTargetW').value, tf: document.getElementById('setTargetF').value };
        localStorage.setItem('myBodySettings', JSON.stringify(s));
        alert("è¨­å®šå·²å„²å­˜");
        renderAll();
    }
    function loadSettings() {
        const s = JSON.parse(localStorage.getItem('myBodySettings'));
        if(s) {
            if(s.h) document.getElementById('setHeight').value = s.h;
            if(s.tw) document.getElementById('setTargetW').value = s.tw;
            if(s.tf) document.getElementById('setTargetF').value = s.tf;
        }
    }

    function fetchData() {
        toggleLoading(true);
        fetch(GOOGLE_SCRIPT_URL)
        .then(res => res.json())
        .then(data => {
            records = data; 
            records.sort((a, b) => new Date(a.date) - new Date(b.date));
            renderAll();
            toggleLoading(false);
        })
        .catch(e => { console.error(e); toggleLoading(false); });
    }

function uploadRecord() {
        // --- 1. å–å¾—åŸºæœ¬æ•¸å€¼ ---
        const date = document.getElementById('inputDate').value;
        const weight = parseFloat(document.getElementById('inputWeight').value);
        const height = parseFloat(document.getElementById('setHeight').value);
        const activity = parseFloat(document.getElementById('inputActivity').value);
        const gender = document.getElementById('inputGender').value;
        const userAge = 35; // ğŸ‚ é è¨­å¹´é½¡ (æ ¹æ“šæ‚¨çš„è³‡æ–™è¨­å®š)ï¼Œå¯è‡ªè¡Œä¿®æ”¹
        
        // åŸºæœ¬é˜²å‘†
        if (!date || !weight) { alert("æ—¥æœŸèˆ‡é«”é‡ç‚ºå¿…å¡«ï¼"); return; }
        if (!height) { alert("è«‹å…ˆåœ¨ä¸Šæ–¹è¨­å®šå€è¼¸å…¥èº«é«˜ï¼"); return; }

        // --- 2. å–å¾—åœåº¦æ•¸æ“š (è‹¥æœ‰çš„è©±) ---
        const neck = parseFloat(document.getElementById('inputNeck').value);
        const waist = parseFloat(document.getElementById('inputWaist').value);
        const hip = parseFloat(document.getElementById('inputHip').value);
        
        const heightM = height / 100;
        const bmi = (weight / (heightM ** 2)).toFixed(1);
        
        let bodyFat = '', bmr = '', tdee = '', ffmi = '';
        
        // åˆ¤æ–·æ˜¯å¦æœ‰è¶³å¤ æ•¸æ“šç®—é«”è„‚ (ç”·æ€§éœ€é ¸è…°ï¼Œå¥³æ€§éœ€é ¸è…°è‡€)
        let hasBodyFatData = (gender === 'male' && neck && waist) || (gender === 'female' && neck && waist && hip);

        // --- 3. æ ¸å¿ƒè¨ˆç®—é‚è¼¯ (é›™è»Œåˆ¶) ---
        if (hasBodyFatData) {
            // ã€æ–¹æ¡ˆ Aã€‘è³‡æ–™é½Šå…¨ï¼šä½¿ç”¨æœ€æº–ç¢ºçš„ Katch-McArdle å…¬å¼ (åŸºæ–¼ç˜¦é«”é‡)
            if (gender === 'male') {
                bodyFat = 495 / (1.0324 - 0.19077 * Math.log10(waist - neck) + 0.1554 * Math.log10(height)) - 450;
            } else {
                bodyFat = 495 / (1.29579 - 0.35004 * Math.log10(waist + hip - neck) + 0.22100 * Math.log10(height)) - 450;
            }
            bodyFat = parseFloat(bodyFat.toFixed(1));
            
            const lbm = weight * (1 - (bodyFat / 100)); // ç˜¦é«”é‡
            bmr = Math.round(370 + (21.6 * lbm));
            ffmi = (lbm / (heightM ** 2)).toFixed(1);

        } else {
            // ã€æ–¹æ¡ˆ Bã€‘è³‡æ–™ä¸è¶³ï¼šä½¿ç”¨ Mifflin-St Jeor å…¬å¼ (åŸºæ–¼é«”é‡èº«é«˜å¹´é½¡)
            // é€™å°±æ˜¯è®“æ‚¨æ²’å¡«åœåº¦ä¹Ÿèƒ½çœ‹åˆ°ä»£è¬æ•¸æ“šçš„é—œéµï¼
            if (gender === 'male') {
                bmr = (10 * weight) + (6.25 * height) - (5 * userAge) + 5;
            } else {
                bmr = (10 * weight) + (6.25 * height) - (5 * userAge) - 161;
            }
            bmr = Math.round(bmr);
            // æ²’åœåº¦ç®—ä¸å‡º FFMIï¼Œä¿æŒç©ºç™½
        }

        // æœ€å¾Œç®—å‡º TDEE (BMR * æ´»å‹•ä¿‚æ•¸)
        if (bmr) {
            tdee = Math.round(bmr * activity);
        }

        // --- 4. æ‰“åŒ…ä¸¦ä¸Šå‚³ ---
        const payload = { date, weight, bmi, bodyFat, ffmi, bmr, tdee };
        sendToGoogle(payload);
    }

    // ğŸ†• æ–°å¢ï¼šåˆªé™¤åŠŸèƒ½
    function deleteRecord(date) {
        if(confirm(`ç¢ºå®šè¦åˆªé™¤ ${date} çš„ç´€éŒ„å—ï¼Ÿ`)) {
            // å‚³é€ action: 'delete' æŒ‡ä»¤çµ¦å¾Œç«¯
            const payload = { action: 'delete', date: date };
            sendToGoogle(payload);
        }
    }

    function sendToGoogle(payload) {
        toggleLoading(true);
        fetch(GOOGLE_SCRIPT_URL, {
            method: 'POST',
            mode: 'no-cors',
            headers: { 'Content-Type': 'text/plain' },
            body: JSON.stringify(payload)
        }).then(() => {
            setTimeout(() => {
                alert("æ“ä½œæˆåŠŸï¼");
                fetchData();
                document.getElementById('inputWeight').value = '';
            }, 1000); 
        }).catch(e => { alert("é€£ç·šéŒ¯èª¤ï¼š" + e); toggleLoading(false); });
    }

    function renderAll() {
        const tbody = document.getElementById('recordList');
        tbody.innerHTML = '';
        const labels = [], wData = [], fData = [], tWData = [], tFData = [];
        const targetW = document.getElementById('setTargetW').value;
        const targetF = document.getElementById('setTargetF').value;

        records.forEach(r => {
            const d = r.date.substring(5, 10);
            const fatShow = r.bodyFat ? `<br><span class="small text-success">${r.bodyFat}%</span>` : '';
            const tdeeShow = r.tdee ? `<span class="fw-bold text-primary">${r.tdee}</span>` : '-';
            const bmiShow = `<br><span class="small text-muted">BMI:${r.bmi}</span>`;

            // åˆ—è¡¨æ¯ä¸€è¡ŒåŠ å…¥åˆªé™¤æŒ‰éˆ•
            const row = `<tr>
                <td>${d}</td>
                <td><b>${r.weight}</b>${fatShow}</td>
                <td>${tdeeShow}${bmiShow}</td>
                <td><button onclick="deleteRecord('${r.date}')" class="btn-del">åˆªé™¤</button></td>
            </tr>`;
            tbody.innerHTML = row + tbody.innerHTML;

            labels.push(d);
            wData.push(r.weight);
            fData.push(r.bodyFat || null);
            tWData.push(targetW || null);
            tFData.push(targetF || null);
        });
        drawChart(labels, wData, fData, tWData, tFData);
    }

    function drawChart(labels, wData, fData, tWData, tFData) {
        const ctx = document.getElementById('trendChart').getContext('2d');
        if (myChart) myChart.destroy();
        myChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: labels,
                datasets: [
                    { label: 'é«”é‡', data: wData, borderColor: '#0d6efd', yAxisID: 'y', tension: 0.3 },
                    { label: 'é«”è„‚', data: fData, borderColor: '#198754', yAxisID: 'y1', tension: 0.3, spanGaps: false },
                    { label: 'ç›®æ¨™é«”é‡', data: tWData, borderColor: '#0d6efd', borderDash: [5,5], pointRadius: 0, borderWidth: 1, yAxisID: 'y', fill: false },
                    { label: 'ç›®æ¨™é«”è„‚', data: tFData, borderColor: '#198754', borderDash: [5,5], pointRadius: 0, borderWidth: 1, yAxisID: 'y1', fill: false }
                ]
            },
            options: {
                responsive: true,
                interaction: { mode: 'index', intersect: false },
                scales: {
                    y: { type: 'linear', display: true, position: 'left' },
                    y1: { type: 'linear', display: true, position: 'right', grid: {drawOnChartArea: false} }
                }
            }
        });
    }
</script>

</body>
</html>

