<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é›²ç«¯é«”æ…‹è¿½è¹¤ v3.0</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { background-color: #f8f9fa; font-family: "Microsoft JhengHei", sans-serif; }
        .card { border: none; box-shadow: 0 4px 15px rgba(0,0,0,0.05); margin-bottom: 25px; border-radius: 12px; }
        .card-header { background-color: #fff; border-bottom: 1px solid #eee; font-weight: bold; font-size: 1.1rem; padding: 15px 20px; }
        .loading-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.8); z-index: 9999; display: flex; justify-content: center; align-items: center; flex-direction: column; visibility: hidden; }
        .spinner-border { width: 3rem; height: 3rem; }
    </style>
</head>
<body>

<div id="loading" class="loading-overlay">
    <div class="spinner-border text-primary" role="status"></div>
    <h4 class="mt-3 text-primary fw-bold">é›²ç«¯åŒæ­¥ä¸­...</h4>
    <p class="text-muted">æ­£åœ¨èˆ‡ Google è©¦ç®—è¡¨é€£ç·š</p>
</div>

<div class="container py-4">
    <h2 class="text-center mb-4 fw-bold text-primary">â˜ï¸ é›²ç«¯é«”é‡è¨ˆéŒ„å™¨</h2>

    <div class="card">
        <div class="card-header">â• æ–°å¢ç´€éŒ„</div>
        <div class="card-body">
            <div class="row g-3">
                <div class="col-md-3">
                    <label class="form-label text-danger fw-bold">æ—¥æœŸ</label>
                    <input type="date" id="inputDate" class="form-control">
                </div>
                <div class="col-md-3">
                    <label class="form-label text-danger fw-bold">é«”é‡ (kg)</label>
                    <input type="number" id="inputWeight" class="form-control" step="0.1" placeholder="å¿…å¡«">
                </div>
                <div class="col-md-6">
                    <label class="form-label">å…¶ä»–åƒæ•¸</label>
                    <div class="input-group">
                        <select id="inputGender" class="form-select"><option value="female">å¥³æ€§</option><option value="male">ç”·æ€§</option></select>
                        <input type="number" id="inputHeight" class="form-control" value="160" placeholder="èº«é«˜">
                    </div>
                </div>
                
                <div class="col-12"><small class="text-muted d-block mb-2">â–¼ è‹¥è¦è¨ˆç®—é«”è„‚ (é¸å¡«)</small></div>
                <div class="col-md-4"><input type="number" id="inputNeck" class="form-control" placeholder="é ¸åœ cm"></div>
                <div class="col-md-4"><input type="number" id="inputWaist" class="form-control" placeholder="è…°åœ cm"></div>
                <div class="col-md-4"><input type="number" id="inputHip" class="form-control" placeholder="è‡€åœ cm"></div>

                <div class="col-12 text-end mt-3">
                    <button onclick="uploadRecord()" class="btn btn-primary px-5 fw-bold">ä¸Šå‚³è‡³é›²ç«¯</button>
                </div>
            </div>
        </div>
    </div>

    <div class="card">
        <div class="card-header d-flex justify-content-between">
            <span>ğŸ“ˆ è¶¨å‹¢åˆ†æ</span>
            <button onclick="fetchData()" class="btn btn-sm btn-outline-secondary">ğŸ”„ é‡æ–°æ•´ç†</button>
        </div>
        <div class="card-body">
            <canvas id="trendChart" height="100"></canvas>
        </div>
    </div>

    <div class="card">
        <div class="card-header">ğŸ“‹ é›²ç«¯æ•¸æ“šåˆ—è¡¨</div>
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-hover align-middle text-center">
                    <thead class="table-light"><tr><th>æ—¥æœŸ</th><th>é«”é‡</th><th>é«”è„‚</th><th>BMI</th><th>ä»£è¬</th></tr></thead>
                    <tbody id="recordList"></tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<script>
    // ==========================================
    // âš ï¸ è«‹åœ¨é€™è£¡è²¼ä¸Šæ‚¨çš„ Google Apps Script ç¶²å€
    const GOOGLE_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbyJc6Com9wU5CtMvVAI57bFUBHs3o8etDRJCR7CzvYMLEQChvFoxGSjM8hCYGxI_gBKRA/exec"; 
    // ==========================================

    document.getElementById('inputDate').valueAsDate = new Date();
    let records = [];
    let myChart = null;

    // å•Ÿå‹•æ™‚è®€å–è³‡æ–™
    window.onload = function() {
        if(GOOGLE_SCRIPT_URL === "https://script.google.com/macros/s/AKfycbyJc6Com9wU5CtMvVAI57bFUBHs3o8etDRJCR7CzvYMLEQChvFoxGSjM8hCYGxI_gBKRA/exec") {
            alert("è«‹è¨˜å¾—ä¿®æ”¹ç¨‹å¼ç¢¼ä¸­çš„ GOOGLE_SCRIPT_URL è®Šæ•¸ï¼");
        } else {
            fetchData();
        }
    };

    // é¡¯ç¤º/éš±è—è®€å–ç•«é¢
    function toggleLoading(show) {
        document.getElementById('loading').style.visibility = show ? 'visible' : 'hidden';
    }

    // 1. å¾ Google è©¦ç®—è¡¨è®€å–è³‡æ–™ (GET)
    function fetchData() {
        toggleLoading(true);
        fetch(GOOGLE_SCRIPT_URL)
        .then(response => response.json())
        .then(data => {
            records = data; // è¦†è“‹èˆŠè³‡æ–™
            // ä¾æ—¥æœŸæ’åº
            records.sort((a, b) => new Date(a.date) - new Date(b.date));
            renderAll();
            toggleLoading(false);
        })
        .catch(error => {
            alert("è®€å–å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯æˆ–ç¶²å€ï¼š" + error);
            toggleLoading(false);
        });
    }

    // 2. ä¸Šå‚³è³‡æ–™åˆ° Google è©¦ç®—è¡¨ (POST)
    function uploadRecord() {
        const date = document.getElementById('inputDate').value;
        const weight = parseFloat(document.getElementById('inputWeight').value);
        const height = parseFloat(document.getElementById('inputHeight').value);
        
        if (!date || !weight) { alert("æ—¥æœŸèˆ‡é«”é‡ç‚ºå¿…å¡«ï¼"); return; }

        // è¨ˆç®—é‚è¼¯
        const heightM = height / 100;
        const bmi = (weight / (heightM ** 2)).toFixed(1);
        
        // é«”è„‚è¨ˆç®—
        const gender = document.getElementById('inputGender').value;
        const neck = parseFloat(document.getElementById('inputNeck').value);
        const waist = parseFloat(document.getElementById('inputWaist').value);
        const hip = parseFloat(document.getElementById('inputHip').value);
        
        let bodyFat = '', bmr = '', tdee = '', ffmi = '';
        
        let hasData = false;
        if (gender === 'male' && neck && waist) hasData = true;
        if (gender === 'female' && neck && waist && hip) hasData = true;

        if (hasData) {
            if (gender === 'male') {
                bodyFat = 495 / (1.0324 - 0.19077 * Math.log10(waist - neck) + 0.1554 * Math.log10(height)) - 450;
            } else {
                bodyFat = 495 / (1.29579 - 0.35004 * Math.log10(waist + hip - neck) + 0.22100 * Math.log10(height)) - 450;
            }
            bodyFat = bodyFat.toFixed(1);
            const lbm = weight * (1 - (bodyFat / 100));
            bmr = Math.round(370 + (21.6 * lbm));
            tdee = Math.round(bmr * 1.2); // é è¨­ä¹…å
            ffmi = (lbm / (heightM ** 2)).toFixed(1);
        }

        // æº–å‚™å‚³é€çš„è³‡æ–™
        const payload = {
            date: date,
            weight: weight,
            bmi: bmi,
            bodyFat: bodyFat,
            ffmi: ffmi,
            bmr: bmr,
            tdee: tdee
        };

        toggleLoading(true);

        // ä½¿ç”¨ fetch ç™¼é€ POST è«‹æ±‚
        fetch(GOOGLE_SCRIPT_URL, {
            method: 'POST',
            mode: 'no-cors', // é€™æ˜¯è§£æ±ºè·¨åŸŸå•é¡Œçš„é—œéµ
            headers: {
                'Content-Type': 'text/plain'
            },
            body: JSON.stringify(payload)
        })
        .then(() => {
            // å›  Google Script å›å‚³ redirect æœƒè¢«ç€è¦½å™¨æ””æˆªï¼Œ
            // åªè¦æ²’å ±éŒ¯ï¼Œæˆ‘å€‘å°±å‡è¨­æˆåŠŸï¼Œä¸¦é‡æ–°è®€å–è³‡æ–™
            setTimeout(() => {
                alert("ä¸Šå‚³æˆåŠŸï¼");
                fetchData(); // é‡æ–°æŠ“å–è³‡æ–™ä»¥æ›´æ–°ç•«é¢
                // æ¸…ç©ºæ¬„ä½
                document.getElementById('inputWeight').value = '';
            }, 1000); 
        })
        .catch(error => {
            alert("ä¸Šå‚³ç™¼ç”ŸéŒ¯èª¤ï¼š" + error);
            toggleLoading(false);
        });
    }

    function renderAll() {
        const tbody = document.getElementById('recordList');
        tbody.innerHTML = '';
        const labels = [], weightData = [], fatData = [];

        records.forEach(r => {
            // è™•ç†æ—¥æœŸå­—ä¸²æ ¼å¼
            const d = r.date.substring(0, 10);
            const row = `<tr>
                <td>${d}</td>
                <td><strong>${r.weight}</strong></td>
                <td>${r.bodyFat ? r.bodyFat+'%' : '-'}</td>
                <td>${r.bmi}</td>
                <td class="small text-muted">${r.tdee ? 'TDEE:'+r.tdee : '-'}</td>
            </tr>`;
            tbody.innerHTML = row + tbody.innerHTML; // æ–°çš„åœ¨ä¸Šé¢

            labels.push(d);
            weightData.push(r.weight);
            fatData.push(r.bodyFat || null);
        });

        drawChart(labels, weightData, fatData);
    }

    function drawChart(labels, weightData, fatData) {
        const ctx = document.getElementById('trendChart').getContext('2d');
        if (myChart) myChart.destroy();
        myChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: labels,
                datasets: [
                    { label: 'é«”é‡', data: weightData, borderColor: '#0d6efd', tension: 0.3 },
                    { label: 'é«”è„‚', data: fatData, borderColor: '#198754', tension: 0.3, spanGaps: false }
                ]
            },
            options: {
                responsive: true,
                scales: { y: { beginAtZero: false } }
            }
        });
    }
</script>

</body>
</html>
